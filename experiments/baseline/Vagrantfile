# Baseline Vagrantfile

$INSTALL_BASE = <<EOF
  export DEBIAN_FRONTEND=noninteractive

  # Update and install dependencies
  sudo apt-get update
  sudo apt-get install -y build-essential 
  sudo apt-get install -y python3-pip 
  sudo apt-get install -y python3-pep8 
  sudo apt-get install -y pkg-config 
  sudo apt-get install -y libboost-all-dev 
  sudo apt-get install -y libssl-dev 
  sudo apt-get install -y libsqlite3-dev 
  sudo apt-get install -y libpcap-dev 
  sudo apt-get install -y libsystemd-dev
  sudo apt-get install -y tcpdump

  # Clone and install mini-ndn
  git clone https://github.com/named-data/mini-ndn.git /home/vagrant/mini-ndn
  cd /home/vagrant/mini-ndn
  git checkout 73add71f860979426aef63136bf78ed525862e5c
  ./install.sh -y --source 

  # Set environment variables in .profile rather than .bashrc
  echo "export PATH=\$PATH:/usr/local/bin" >> /home/vagrant/.profile
  echo "export LD_LIBRARY_PATH=\$LD_LIBRARY_PATH:/usr/local/lib64/" >> /home/vagrant/.profile
  echo "export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig/" >> /home/vagrant/.profile
EOF

Vagrant.configure("2") do |config|
  config.vm.box = "minindn"
  config.vm.box_url = "../../minindn-vm/minindn.box"

  config.vm.network "private_network", type: "dhcp"

  config.vm.provider :virtualbox do |v|
    v.customize ["modifyvm", :id, "--cpus", "4"]
    v.customize ["modifyvm", :id, "--memory", "32768"]
    v.customize ["modifyvm", :id, "--vram", "256"]
    v.gui = false
  end

  config.vm.provision "shell", inline: $INSTALL_BASE, privileged: false

  # Explicitly transfer host files to VM
  config.vm.provision "file", source: "../baseline", destination: "/home/vagrant/mini-ndn/flooding/experiments/baseline"
  config.vm.provision "file", source: "../tools", destination: "/home/vagrant/mini-ndn/flooding/experiments/tools"

  config.vm.provision "shell", inline: <<-SHELL
    mkdir -p /home/vagrant/mini-ndn/flooding/experiments/baseline
    mkdir -p /home/vagrant/mini-ndn/flooding/experiments/tools
  SHELL

end
