#Initial Box Vagrantfile

$INSTALL_BASE = <<EOF
  set -e -u -o pipefail

  # Packages to install, in alphabetical order:
  PKGS="build-essential \
        ca-certificates \
			  git \
			  libboost-all-dev \
			  libigraph-dev \
			  libpcap-dev \
			  libsqlite3-dev \
			  libssl-dev \
			  libsystemd-dev \
			  network-manager \
        python-is-python3 \
			  python3-pep8 \
			  python3-pip \
			  python3-venv \
			  pkg-config \
        software-properties-common \
			  tcpdump"

  # Update and install dependencies
  sudo DEBIAN_FRONTEND=noninteractive apt-get update
  sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq --no-install-recommends $PKGS

  # --- Non-interactive tshark installation ---
  # Pre-answer the wireshark-common configuration question to avoid interactive prompts
  echo "wireshark-common wireshark-common/install-setuid boolean true" | sudo debconf-set-selections
  sudo DEBIAN_FRONTEND=noninteractive apt-get install -y tshark

  # Set environment variables in .profile
  echo "export PATH=\$PATH:/usr/local/bin"                  >> /home/vagrant/.profile
  echo "export LD_LIBRARY_PATH=/usr/local/lib64/"           >> /home/vagrant/.profile
  echo "export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig/" >> /home/vagrant/.profile
EOF

Vagrant.configure("2") do |config|
  config.vm.box = "bento/ubuntu-22.04"
  config.vm.box_version = "202309.08.0"

  # Sync the project root directory (../../ from this file's location) to /vagrant in the VM
  config.vm.synced_folder "../../", "/vagrant", type: "rsync"

  config.vm.network "private_network", type: "dhcp"

  common_cpus   = 4
  common_memory = 4096

  config.vm.provider :virtualbox do |vb|
    vb.name = "initial-virtualbox"
    config.vm.synced_folder "../../", "/vagrant", type: "virtualbox"
    vb.cpus = common_cpus
    vb.memory = common_memory
    vb.customize ["modifyvm", :id, "--vram", "256"]
    vb.gui = false
  end

  config.vm.provider :libvirt do |lv|
    lv.driver = "kvm"
    require 'etc'
    dirname = __dir__.split('/')[-2..-1].join('-')
    lv.default_prefix = "#{Etc.getpwuid.uid}-#{dirname}-"
    lv.cpus   = common_cpus
    lv.memory = common_memory
  end

  config.vm.provision "shell", inline: $INSTALL_BASE, privileged: false
end
